ServerName localhost
ServerAdmin webmaster@localhost

<VirtualHost *:80>
  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L] 
</VirtualHost>

<VirtualHost *:443>
  DocumentRoot /var/www/html
 
  SSLEngine On
  SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
 
  LogLevel info ssl:warn

  # FIXME: See how official image handles this.  Globally? 
  ErrorLog /dev/stderr 
  CustomLog /dev/stdout combined
 
  OIDCCryptoPassphrase 1234567890
  OIDCSSLValidateServer Off
  OIDCProviderMetadataURL https://192.168.99.100:8443/auth/realms/master/.well-known/openid-configuration 
  OIDCClientID admin-api
  OIDCRedirectURI https://192.168.99.100:8443/redirect_url
  OIDCRemoteUserClaim preferred_username
  OIDCResponseType "id_token token"
 
  <Location /secure/>
    AuthType openid-connect
    Require valid-user
  </Location>

  OIDCOAuthClientID admin-api
  OIDCOAuthSSLValidateServer Off
  OIDCOAuthRemoteUserClaim preferred_username
  OIDCOAuthIntrospectionEndpoint https://192.168.99.100:8443/auth/realms/master/protocol/openid-connect/token/introspect
  #OIDCOAuthVerifyJwksUri https://192.168.99.100:8443/auth/realms/master/protocol/openid-connect/certs

  <Location "/api">
    LogMessage "LOG MESSAGE!!!  %{REQUEST_METHOD} %{REQUEST_URI}"

    # CORS Allow ALL Origins
    Header always set Access-Control-Allow-Origin "*"

    # CORS Preflight
    <If "%{REQUEST_METHOD} == 'OPTIONS' && %{HTTP:Access-Control-Request-Headers} != '' && %{HTTP:Access-Control-Request-Method} != ''">
        LogMessage "CORS Preflight Request: Headers: %{req:Access-Control-Request-Headers} Methods: %{req:Access-Control-Request-Method}"
        
        Header always set Access-Control-Allow-Methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS, HEAD"
        Header always set Access-Control-Allow-Headers: "Authorization"
        Header always set Access-Control-Max-Age "1000"

        RewriteEngine On

        # FIXME: Get rid of HTML error page returned in OPTIONS response
        RewriteRule ^(.*)$ $1 [R=200,L]    
    </If>

    AuthType oauth20
    AuthName "OpenID Connect"
    #Require all granted
    Require valid-user

    ProxyPass http://echo:5000
    ProxyPassReverse http://echo:5000 
  </Location>

</VirtualHost>

<VirtualHost *:8443>
  # Required by Keycloak, but not automatically set by mod_proxy
  ProxyPreserveHost On
  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Forwarded-Port "8443"

  # Simple CORS passthru to Keycloak
  # TODO: There is likely more work to get this secure.
  Header set Access-Control-Allow-Origin "*"

  SSLEngine On
  SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

  ProxyPass / http://keycloak:8080/
  ProxyPassReverse / http://keycloak:8080/
</VirtualHost>

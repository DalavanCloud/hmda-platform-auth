ServerName localhost

# Force all traffic to HTTPS
<VirtualHost *:8080>
  RewriteEngine On
  RewriteCond %{HTTPS} off
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [R,L] 
</VirtualHost>

<VirtualHost *:8443>
  DocumentRoot /var/www/html

  # Makes $HOSTNAME available as SSI envvar
  PassEnv HOSTNAME

  # Enable HTTPS with default Apache cert 
  SSLEngine On
  SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

  # mod_auth_openidc config 
  OIDCClientID ${OIDC_CLIENT_ID}
  OIDCProviderMetadataURL ${OIDC_METADATA_URI}
  OIDCOAuthVerifyJwksUri ${OIDC_JWKS_URI}
  OIDCRedirectURI ${OIDC_REDIRECT_URI}
  OIDCCryptoPassphrase ${CRYPTO_PASSPHRASE}
  OIDCClaimPrefix ${CLAIM_HEADER_PREFIX}
  OIDCOAuthSSLValidateServer ${VALIDATE_SSL}
  OIDCOAuthRemoteUserClaim ${REMOTE_USER_CLAIM} 
  OIDCAuthNHeader ${REMOTE_USER_HEADER}

  # Upstream API Location
  <Location "${API_PATH_PREFIX}">
    AuthType oauth20
    AuthName "OpenID Connect (HMDA Ops)"
    Require valid-user
    #AuthType None
    #Require all granted

    LogMessage "REMOTE_USER: %{REMOTE_USER}"
 
    ProxyPass ${UPSTREAM_API_URI}
    ProxyPassReverse ${UPSTREAM_API_URI}
  </Location>

  # Top-level path, providing default settings for CORS and OIDC
  <Location "/">

    LogMessage "Root Location Start"

    # CORS Allow ALL Origins
    Header always set Access-Control-Allow-Origin "*"

    LogMessage "Origin: %{req:Origin}"
    
    # CORS Preflight
    # SEE: https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Preflighted_requests 
    <If "%{REQUEST_METHOD} == 'OPTIONS' && %{HTTP:Access-Control-Request-Headers} != '' && %{HTTP:Access-Control-Request-Method} != ''">
        LogMessage "CORS Preflight Request: Headers: %{req:Access-Control-Request-Headers} Methods: %{req:Access-Control-Request-Method}"
        
        Header always set Access-Control-Allow-Methods: "GET, POST, PUT, PATCH, DELETE, OPTIONS, HEAD"
        Header always set Access-Control-Allow-Headers: "Authorization, Cache-Control, Accept, Content-Type"
        Header always set Access-Control-Max-Age "1000"

        AuthType None
        Require all granted

        RewriteEngine On
        RewriteRule ^(.*)$ $1 [R=204,L]
        #RedirectMatch 204 ^(.*)$ $1
    </If>

    #ProxyPass !
  </Location>

</VirtualHost>
